<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css" integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm" crossorigin="anonymous">
	<title>User page</title>
	<style>
        #user-video {
            bottom: 20px;
            right: 20px;
            position: absolute !important;
        }
        #user-video video{
            height: 20vh;
        }

        #volunteer-video {
            bottom: 20px;
            left: 20px;
            position: absolute !important;
        }
        #volunteer-video video{
            height: 20vh;
        }
		.video{
			height: 50vh;
			width: 100%;
		}
        .ringing{
            width: 100%;
            height: 100vh;
            background-color: rgba(0, 0, 0, 1);
            z-index: 99999999;
            position: absolute;
        }
	</style>
</head>
<body>
    <!-- <div id="test"></div> -->
    <div class="ringing">
        <p id="call-text" style="color: white;text-align: center;font-weight: bold; left: 50%; top: 50vh; transform: translate(-50%, -50%); position: absolute; font-size: 20px;">Ringing...</p>
        <img src="assets/img/icons/red/call.svg" style="width: 15%; height: auto; transform: translate(-50%, -50%); position: absolute; left: 50%; top: 85%;" alt="" title="" onclick="decline()" />
    </div>
    <div id="user-video"></div>
    <div id="operator-video"></div>
    <div id="volunteer-video"></div>
	<script src="https://unpkg.com/peerjs@1.3.1/dist/peerjs.min.js"></script>
    <script type="module">
        // firebaseConfig
		let myStream;
        let is_user_added = false;
        let is_operator_added = false;
        let is_volunteer_added = false;

        const operatorPeer  =  new Peer({
            config: {'iceServers': [
                { url: 'stun:stun4.l.google.com:19302' },
                {
                    url: 'turn:192.158.29.39:3478?transport=udp',
                    credential: 'JZEOEt2V3Qb0y27GRntt2u2PAYA=',
                    username: '28224511:1379330808'
                },
            ]} /* Sample servers, please use appropriate ones */
        });

        const volunteerPeer =  new Peer({
            config: {'iceServers': [
                { url: 'stun:stun4.l.google.com:19302' },
                {
                    url: 'turn:192.158.29.39:3478?transport=udp',
                    credential: 'JZEOEt2V3Qb0y27GRntt2u2PAYA=',
                    username: '28224511:1379330808'
                },
            ]} /* Sample servers, please use appropriate ones */
        });

        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.0.0/firebase-app.js";
        import { getDatabase, ref, push } from "https://www.gstatic.com/firebasejs/9.0.0/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBF9vuotZeqwkLDGgc3hM_PmuwEz_rCMLE",
            authDomain: "webrtc-test-1e07e.firebaseapp.com",
            databaseURL: "https://webrtc-test-1e07e-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "webrtc-test-1e07e",
            storageBucket: "webrtc-test-1e07e.appspot.com",
            messagingSenderId: "331519699004",
            appId: "1:331519699004:web:bdf99364e08e6ecb85bb39",
            measurementId: "G-XH9CNSCXZ9"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);

        const qSelect = el => document.querySelector(el);

        document.addEventListener("DOMContentLoaded", (event) => {
            // Play Our Video
            navigator.mediaDevices.getUserMedia({
                video: true, audio: true
            }).then((stream) => {
                addUserVideo(stream);
                myStream = stream;
                // qSelect('#test').innerText += '/n streamed';
            });

            operatorPeer.on('open',function (id){
                const db = getDatabase();
                let pushed = push(ref(db, `user/operator`), { id, is_viewed: false });
                // qSelect('#test').innerText += '/n push operator peer';
            }); 

            volunteerPeer.on('open',function (id){
                const db = getDatabase();
                let pushed = push(ref(db, `user/volunteer`), { id, is_viewed: false });
                // qSelect('#test').innerText += '/n push volunteer peer';
            }); 

            operatorPeer.on('call', function (call){
                qSelect('#call-text').innerText = 'Connecting...';
                call.answer(myStream);
                call.on('stream', function (remoteStream) {
                    addOperatorVideo(remoteStream);
                })
                // qSelect('#test').innerText += '/n operator peer on call';
            })

            volunteerPeer.on('call', function (call){
                call.answer(myStream);
                call.on('stream', function (remoteStream) {
                    addVolunteerVideo(remoteStream);
                })
                // qSelect('#test').innerText += '/n operator peer on call';
            })

            const addOperatorVideo = (stream) => {
                if ( !is_operator_added ) {
                    let video = document.createElement('video');
                        video.classList.add('video');
                        video.style.height = "100vh";
                        video.style.objectFit = "cover";
                        video.srcObject = stream;
                        video.style.minWidth = '30%';
                        video.play();

                    qSelect('#operator-video').append(video);

                    is_operator_added = true;
                    qSelect('.ringing').remove();
                // qSelect('#test').innerText += '/n adding video operator';
                }
            }

            const addUserVideo = (stream) => {
                if ( !is_user_added ) {
                    let video = document.createElement('video');
                        video.classList.add('video');
                        video.srcObject = stream;
                        video.play();

                    qSelect('#user-video').append(video);
                    is_user_added = true;
                // qSelect('#test').innerText += '/n adding user video';
                }
            }

            const addVolunteerVideo = (stream) => {
                if ( !is_volunteer_added ) {
                    let video = document.createElement('video');
                        video.classList.add('video');
                        video.srcObject = stream;
                        video.play();

                    qSelect('#volunteer-video').append(video);
                    is_volunteer_added = true;

                    // qSelect('#test').innerText += '/n adding volunteer video';
                }
            }
        })
    </script>
</body>
</html>
