<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css" integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm" crossorigin="anonymous">
	<title>Operator page</title>
	<style>
        #operator-video {
            bottom: 20px;
            right: 20px;
            position: absolute !important;
        }
        #operator-video video{
            height: 15vh;
        }
		.video{
			height: 50vh;
			width: 100%;
		}
	</style>
</head>
<body>
    <button class="btn btn-primary" style="position: absolute;right: 10px; top: 20px;" id="invite-volunteer-button" onclick="console.log('k')">Invite Volunteer</button>
    <div id="user-video"></div>
    <div id="operator-video"></div>
    <div id="volunteer-video"></div>
    <button class="btn btn-primary" id="accept-phone" style="bottom: 20px; position: absolute; left: 50%; transform: translateX(-50%);display: none;">Accept Phone</button>
	<script src="https://unpkg.com/peerjs@1.3.1/dist/peerjs.min.js"></script>
    <script type="module">
        let myStream;
        const qSelect = el => document.querySelector(el);
        const userPeer  = new Peer();
        const volunteerPeer = new Peer();

        let userPeerID;
        let peerList = [];

        // Import the functions you need from the SDKs you need
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.0.0/firebase-app.js";
        import { getDatabase, ref, onChildAdded, update, push } from "https://www.gstatic.com/firebasejs/9.0.0/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBF9vuotZeqwkLDGgc3hM_PmuwEz_rCMLE",
            authDomain: "webrtc-test-1e07e.firebaseapp.com",
            databaseURL: "https://webrtc-test-1e07e-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "webrtc-test-1e07e",
            storageBucket: "webrtc-test-1e07e.appspot.com",
            messagingSenderId: "331519699004",
            appId: "1:331519699004:web:bdf99364e08e6ecb85bb39",
            measurementId: "G-XH9CNSCXZ9"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const database = getDatabase();

        document.addEventListener("DOMContentLoaded", (event) => {
            const scheduleRef = ref(database, `/user/operator`);
            onChildAdded(scheduleRef, (snapshot) => {
                const data = snapshot.val();
                if ( !data.is_viewed ) {
                    let scheduleChildRef = ref(database, `/user/operator/${snapshot.key}`)
                    update(scheduleChildRef, {
                        is_viewed: true
                    });
                    userPeerID = data.id;
                    
                    showAnswerButton();
                }
            });
        })

        const showAnswerButton = () => {
            qSelect('#accept-phone').style.display = 'block';
        }

        // User Peer
        qSelect('#accept-phone').addEventListener('click', () => {
            navigator.mediaDevices.getUserMedia({
                video: true, audio: true
            }).then((stream) => {
                myStream = stream;
                addOperatorVideo(stream);
                let call = userPeer.call(userPeerID, stream);
                call.on('stream', function (remoteStream) {
                    console.log('ok');
                    if (!peerList.includes(call.peer)) {
                        addUserVideo(remoteStream);
                        peerList.push(call.peer);
                    }
                })
            }).catch((err) => {
                console.log(err);
            });
            qSelect('#accept-phone').remove();
        });

        // Volunteer Peer
        
        volunteerPeer.on('open',function (id){
            const db = getDatabase();
            let pushed = push(ref(db, `operator/volunteer`), { id, is_viewed: false });
        }); 

        volunteerPeer.on('call', function (call){
            call.answer(myStream);
            call.on('stream', function (remoteStream) {
                addVolunteerVideo(remoteStream);
            })
        })

        const addOperatorVideo = (stream) => {
            let video = document.createElement('video');
                video.classList.add('video');
                video.srcObject = stream;
                video.play();

            qSelect('#operator-video').append(video);
        }

        const addUserVideo = (stream) => {
            let video = document.createElement('video');
                video.classList.add('video');
                video.style.height = "100vh";
                video.style.objectFit = "cover";
                video.srcObject = stream;
                video.style.minWidth = '30%';
                video.play();

            qSelect('#user-video').append(video);
        }

        const addVolunteerVideo = (stream) => {
            let video = document.createElement('video');
                video.classList.add('video');
                video.srcObject = stream;
                video.play();

            qSelect('#volunteer-video').append(video);
        }
    </script>
</body>
</html>
