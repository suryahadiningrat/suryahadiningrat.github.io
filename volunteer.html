<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css" integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm" crossorigin="anonymous">
	<title>Volunteer page</title>
	<style>
		.video{
			height: 50vh;
			width: 100%;
		}
        #operator-video video{
            position: absolute;
            bottom: 0px;
            left: 0;
        }
        #volunteer-video video{
            position: absolute;
            bottom: 0px;
            right: 0;
        }

        .main-video{
            width: 100%;
            height: 100vh;
            background-color: blue;
        }

        .secondary-video{
            width: 40%;
            height: 30vh;
            position: absolute;
            bottom: 0;
            background-color: white;
        }
	</style>
</head>
<body>
    <button class="btn btn-primary" style="position: absolute;right: 10px; top: 20px; display: none;" id="invite-volunteer-button">Invite Volunteer</button>
    <div class="main-video text-center" id="user-video">User Video</div>
    <div class="secondary-video text-center" id="operator-video">Operator Video</div>
    <div class="secondary-video text-center"style="right: 0;" id="volunteer-video">Volunteer Video</div>
    <button class="btn btn-primary" id="accept-phone" style="bottom: 20px; position: absolute; left: 50%; transform: translateX(-50%);display: none;">Accept Phone</button>
	<script src="https://unpkg.com/peerjs@1.3.1/dist/peerjs.min.js"></script>
    <script type="module">
        const peer = new Peer();
        let is_volunteer = false;
        let myStream;
        const qSelect = el => document.querySelector(el);
        let remotePeerID;
        let peerList = [];

        // Import the functions you need from the SDKs you need
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.0.0/firebase-app.js";
        import { getDatabase, ref, onChildAdded, update } from "https://www.gstatic.com/firebasejs/9.0.0/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBF9vuotZeqwkLDGgc3hM_PmuwEz_rCMLE",
            authDomain: "webrtc-test-1e07e.firebaseapp.com",
            databaseURL: "https://webrtc-test-1e07e-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "webrtc-test-1e07e",
            storageBucket: "webrtc-test-1e07e.appspot.com",
            messagingSenderId: "331519699004",
            appId: "1:331519699004:web:bdf99364e08e6ecb85bb39",
            measurementId: "G-XH9CNSCXZ9"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const database = getDatabase();

        document.addEventListener("DOMContentLoaded", (event) => {
            const scheduleRef = ref(database, `/volunteer`);
            onChildAdded(scheduleRef, (snapshot) => {
                const data = snapshot.val();
                if ( !data.is_viewed ) {
                    let scheduleChildRef = ref(database, `/volunteer/${snapshot.key}`)
                    update(scheduleChildRef, {
                        is_viewed: true
                    });
                    remotePeerID = data.id;
                    
                    showAnswerButton();
                }
            });
        })

        const showAnswerButton = () => {
            qSelect('#accept-phone').style.display = 'block';
        }

        qSelect('#accept-phone').addEventListener('click', () => {
            navigator.mediaDevices.getUserMedia({
                video: true, audio: true
            }).then((stream) => {
                myStream = stream;
                addOurVideo(stream);
                let call = peer.call(remotePeerID, stream);
                call.on('stream', function (remoteStream) {
                    console.log(remoteStream);
                    if (!peerList.includes(call.peer)) {
                        is_volunteer = true;
                        addRemoteVideo(remoteStream, remotePeerID);
                        peerList.push(call.peer);
                    }
                    if ((!peerList.includes(call.peer)) && (is_volunteer)) {
                        addVolunteerVideo(remoteStream, remotePeerID);
                        peerList.push(call.peer);
                    }
                })
            }).catch((err) => {
                console.log(err);
            });
            qSelect('#accept-phone').remove();
        });

        const addRemoteVideo = (stream) => {
            let video = document.createElement('video');
                video.classList.add('video');
                video.srcObject = stream;
                video.play();

            qSelect('#user-video').append(video);
        }

        const addOurVideo = (stream) => {
            console.log('connected');
            let video = document.createElement('video');
                video.classList.add('video');
                video.srcObject = stream;
                video.play();

            qSelect('#operator-video').append(video);
        }

        const addVolunteerVideo = (stream) => {
            console.log('connected');
            let video = document.createElement('video');
                video.classList.add('video');
                video.srcObject = stream;
                video.play();

            qSelect('#volunteer-video').append(video);
        }
    </script>
</body>
</html>